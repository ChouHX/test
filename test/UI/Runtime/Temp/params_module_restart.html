<style type="text/css">
  /*tab style*/
  #tbl_res tr{
    cursor: pointer;
  }
  #tbl_res input{
    vertical-align: middle;
  }
  .tr_selected_cfg{
    background: #aedae4;
  }
  .params-tab-content .tab-pane{
    padding-top: 10px;
  }
  #fm_rwcs{
    margin-top: 10px;
  }

  /*params input style*/
  .ck-top-0{
    top: 0;
  }
  .form-horizontal label.input-notes{
    text-align: left;
    color: gray;
  }

  /*loading*/
  .my-loading{
    position: absolute;
    top: 0;
    left: 0;
    z-index: 100;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,.6) url(/./Tpl/Public/images/loading.gif) no-repeat center;
  }

  /*task dest ul*/
  .task-dest{
    list-style: none;
    display: inline-block;
    margin: 0;
    padding: 0;
  }
  .task-dest li{
    float: left;
    background-color: #ecf0f5;
    margin: 0 20px 15px 0;
    line-height: 30px;
    padding: 0 5px;
    border-radius: 3px;
  }
  .timed-task-params{
    display: none;
  }
  .timed-task-params .checkbox-inline{
    min-width: 45px;
  }
</style>
<div class="modal-header">
  <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
  <h4 class="modal-title"></h4>
</div>
<div class="modal-body">
  <form class="form-horizontal" role="form" id="fm_rwcs" style="margin-top: 20px; /*border: 1px solid #ddd; padding-top: 15px;*/">
    <div class="form-group">
      <label class="col-md-2 control-label">选择模块:</label>
      <div class="col-md-8">
        <select class="form-control" name="module">
          <option value="1" selected>模块1</option>
          <option value="2">模块2</option>
        </select>
      </div>
    </div>
    <hr/>
    <div class="form-group">
      <label for="starttime" class="col-lg-2 control-label">任务开始时间：</label>
      <div class="col-lg-3">
        <input type="text" class="form-control" name="start_dt" id="start_dt" value="" />
      </div>
      <label class="col-lg-7 control-label input-notes">在开始时间之前，任务将不会被执行</label>
    </div>
    <div class="form-group">
      <label for="endtime" class="col-lg-2 control-label">任务过期时间：</label>
      <div class="col-lg-3">
        <input type="text" class="form-control" name="end_dt" id="end_dt" value="" />
      </div>
      <label class="col-lg-7 control-label input-notes">在过期时间之后，未执行完成的任务将显示超时</label>
    </div>
    <div class="form-group">
      <label class="col-lg-2 control-label">自动重试：</label>
      <div class="col-lg-3">
        <label class="checkbox-inline">
          <input type="checkbox" name="auto_retry" class="ck-top-0" />
        </label>
      </div>
      <label class="col-lg-7 control-label input-notes">任务下发后超过1分钟未收到设备回复，将再次下发</label>
    </div>
    <div class="form-group">
      <label class="col-lg-2 control-label">定期执行：</label>
      <div class="col-lg-3">
        <select class="form-control" id="select_timed_type">
          <option value="-1">禁用</option>
          <option value="1" data-show="1,3,6">每月执行</option>
          <option value="2" data-show="2,3,6">每周执行</option>
          <option value="3" data-show="4,6">每天执行</option>
          <option value="4" data-show="5">每小时执行</option>
        </select>
      </div>
    </div>
    <div class="form-group timed-task-params timed-params-1">
      <label class="col-lg-2 control-label">日期：</label>
      <div class="col-lg-10">
        <label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="1" name="days" />1</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="2" name="days" />2</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="3" name="days" />3</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="4" name="days" />4</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="5" name="days" />5</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="6" name="days" />6</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="7" name="days" />7</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="8" name="days" />8</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="9" name="days" />9</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="10" name="days" />10</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="11" name="days" />11</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="12" name="days" />12</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="13" name="days" />13</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="14" name="days" />14</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="15" name="days" />15</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="16" name="days" />16</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="17" name="days" />17</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="18" name="days" />18</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="19" name="days" />19</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="20" name="days" />20</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="21" name="days" />21</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="22" name="days" />22</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="23" name="days" />23</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="24" name="days" />24</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="25" name="days" />25</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="26" name="days" />26</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="27" name="days" />27</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="28" name="days" />28</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="29" name="days" />29</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="30" name="days" />30</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" value="31" name="days" />31</label>      </div>
    </div>
    <div class="form-group timed-task-params timed-params-2">
      <label class="col-lg-2 control-label">星期：</label>
      <div class="col-lg-10">
        <label class="checkbox-inline"><input type="checkbox" name="weeks" value="0" />日&nbsp;&nbsp;</label><label class="checkbox-inline"><input type="checkbox" name="weeks" value="1" />一&nbsp;&nbsp;</label><label class="checkbox-inline"><input type="checkbox" name="weeks" value="2" />二&nbsp;&nbsp;</label><label class="checkbox-inline"><input type="checkbox" name="weeks" value="3" />三&nbsp;&nbsp;</label><label class="checkbox-inline"><input type="checkbox" name="weeks" value="4" />四&nbsp;&nbsp;</label><label class="checkbox-inline"><input type="checkbox" name="weeks" value="5" />五&nbsp;&nbsp;</label><label class="checkbox-inline"><input type="checkbox" name="weeks" value="6" />六&nbsp;&nbsp;</label>      </div>
    </div>
    <div class="form-group timed-task-params timed-params-3">
      <label class="col-lg-2 control-label">小时：</label>
      <div class="col-lg-2">
        <div class="input-group">
          <select class="form-control">
            <option value="0">00</option><option value="1">01</option><option value="2">02</option><option value="3">03</option><option value="4">04</option><option value="5">05</option><option value="6">06</option><option value="7">07</option><option value="8">08</option><option value="9">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>          </select>
          <div class="input-group-addon" style="background: #f4f4f4">时</div>
        </div>
      </div>
    </div>
    <div class="form-group timed-task-params timed-params-4">
      <label class="col-lg-2 control-label">小时：</label>
      <div class="col-lg-10">
        <label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="0" />00</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="1" />01</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="2" />02</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="3" />03</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="4" />04</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="5" />05</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="6" />06</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="7" />07</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="8" />08</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="9" />09</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="10" />10</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="11" />11</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="12" />12</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="13" />13</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="14" />14</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="15" />15</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="16" />16</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="17" />17</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="18" />18</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="19" />19</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="20" />20</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="21" />21</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="22" />22</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="hours" value="23" />23</label>      </div>
    </div>
    <div class="form-group timed-task-params timed-params-5">
      <label class="col-lg-2 control-label">分钟：</label>
      <div class="col-lg-10">
        <label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="0" />00</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="5" />05</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="10" />10</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="15" />15</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="20" />20</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="25" />25</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="30" />30</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="35" />35</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="40" />40</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="45" />45</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="50" />50</label><label class="checkbox-inline" style="margin-left:10px"><input type="checkbox" name="minutes" value="55" />55</label>      </div>
    </div>
    <div class="form-group timed-task-params timed-params-6">
      <label class="col-lg-2 control-label">分钟：</label>
      <div class="col-lg-2">
        <div class="input-group">
          <select class="form-control">
            <option value="0">00</option><option value="5">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option>          </select>
          <div class="input-group-addon" style="background: #f4f4f4">分</div>
        </div>
      </div>
    </div>
  <input type="hidden" name="__hash__" value="00831b701a7c1c948e828678f6becebb_6057710c6531973404540deb1c3721e1" /></form>
</div>
<div class="modal-footer">
  <button type="button" class="btn btn-success" onclick="javascript:$.gf.submit_task();">保存</button>
  <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
</div>

<script type="text/javascript">
  (function($) {
    $.gf.daterangepicker_opt = {
      "singleDatePicker": true,
      "timePicker": true,
      "timePicker24Hour": true,
      // 'drops': $.inArray($.gf.tp.task_type, ['termRestart','configGet','cfgFileUpload','rtuScriptGet']) === -1 ? 'up' : 'down',
      "locale": {
        "format": "YYYY-MM-DD HH:mm:ss",
        "daysOfWeek": $lang.VAR_WEEK_ARR,
        "monthNames": $lang.VAR_MONTH.replace('[','').replace(']','').replace(/'/g,'').split(','),
        "applyLabel": $lang.VAR_BTN_SURE,
        "cancelLabel": $lang.VAR_BTN_CANCLE
      }
    }

    $.gf.submit_task = function() {
      var params = {
        start_ts: new Date($('#start_dt').val().replace(/-/g, '/')).getTime() / 1000,
        end_ts: new Date($('#end_dt').val().replace(/-/g, '/')).getTime() / 1000,
        act: $.gf.tp.dest_type,
        check_model: $.gf.tp.check_model,
        enable_model: $.gf.tp.enable_model,
        auto_retry: $('#fm_rwcs input[name=auto_retry]').is(':checked') ? 1 : 0
      };
      if ($.gf.tp.dest_type == 'term') {
        var sns = $('#list2').jqGrid('getGridParam','selarrrow');
        params.term_list = sns.join(',');
      } else if ($.gf.tp.dest_type == 'group') {
        params.gids = $('#change_gid span').attr('data-id');
      }

      // 定时任务参数
      params.timed_type = parseInt($('#select_timed_type').val());
      if (params.timed_type != -1) {
        var v1 = [], v2 = [], v3 = $('.timed-params-3 select').val(), v4 = [], v5 = [], v6 = $('.timed-params-6 select').val();
        $('.timed-params-1 input[name=days]').each(function(){
          if ($(this).is(':checked')) v1.push($(this).val());
        });
        $('.timed-params-2 input[name=weeks]').each(function(){
          if ($(this).is(':checked')) v2.push($(this).val());
        });
        $('.timed-params-4 input[name=hours]').each(function(){
          if ($(this).is(':checked')) v4.push($(this).val());
        });
        $('.timed-params-5 input[name=minutes]').each(function(){
          if ($(this).is(':checked')) v5.push($(this).val());
        });
        switch (params.timed_type) {
          case 1:
            if (v1.length == 0) {
              $.notice(1, $lang.TIPS_SELECT_EXEC_DATE);
              return;
            }
            params.timed_params = v6+'|'+v3+'|'+v1.join(',')+'|0';
            break;
          case 2:
            if (v2.length == 0) {
              $.notice(1, $lang.TIPS_SELECT_EXEC_DATE);
              return;
            }
            params.timed_params = v6+'|'+v3+'|0|'+v2.join(',');
            break;
          case 3:
            if (v4.length == 0) {
              $.notice(1, $lang.TIPS_SELECT_EXEC_TIME);
              return;
            }
            params.timed_params = v6+'|'+v4.join(',')+'|0|0';
            break;
          case 4:
            if (v5.length == 0) {
              $.notice(1, $lang.TIPS_SELECT_EXEC_TIME);
              return;
            }
            params.timed_params = v5.join(',')+'|0|0|0';
            break;
        }
      }

      // 指令下发相关参数
      var obj = $('#fm_rwcs').data('bootstrapValidator');
      obj.validate();
      if (!obj.isValid()){
          return;
      }
      var p2 = $.serializeObject('#fm_rwcs');
      $.extend(params, {
        module: p2.module,
      });

      var do_work = function() {
        ajax(tpurl('Task', $.gf.tp.task_type), params, function(msg) {
          msg.data ? $.notice(1, msg.info) : $.notice(msg);
          if (msg.status == 0 || msg.status == 1) {
            $('#rwcs2Modal').modal('hide');
            $.gf.getStaticsInfo();
          }
        });
      }

      if ($.gf.tp.dest_type == 'group' || $.gf.tp.dest_type == 'all') {
        $.confirm($lang.TASK_TARGET+'：' + ($.gf.tp.dest_type == 'group' ? $('#change_gid span').html() : $lang.VAR_ALL_ROUTER)+'<br>' +
          $lang.VAR_CMD_NAME+'：'+$.gf.tp.task_name+'<br>' +
          '<span style="color:red">'+$lang.BATCH_OPERATION_CONFIRM+'</span>', function(){
          do_work();
        });
      } else {
        do_work();
      }
    }

    $(document).ready(function() {
      $('#rwcs2Modal h4').html($.gf.tp.task_name);
      $('#start_dt').val(moment().format('YYYY-MM-DD HH:mm:00')).daterangepicker($.gf.daterangepicker_opt);
      $('#end_dt').val(moment().add(30, 'days').format('YYYY-MM-DD HH:mm:00')).daterangepicker($.gf.daterangepicker_opt);

      $('#fm_rwcs').bootstrapValidator({
          feedbackIcons: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
          },
      });

      // 切换定期执行
      $('#select_timed_type').on('change', function() {
        var v = $(this).val(), ids = $(this).find('option:selected').attr('data-show');
        v != -1 ? $('#fm_rwcs input[name=auto_retry]').prop('checked', false).attr('disabled', true) : $('#fm_rwcs input[name=auto_retry]').removeAttr('disabled');
        for (var i=1,o=null; i<7; i++) {
          o = $('div.timed-params-'+i);
          if (v == -1) {
            o.hide();
          } else {
            ids.indexOf(i) != -1 ? o.show() : o.hide();
          }
        }
      });
    });
  })(jQuery);
</script>